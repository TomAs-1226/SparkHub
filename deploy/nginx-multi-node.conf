# SparkHub — Multi-node nginx load balancer config
#
# Architecture:
#   [Internet] → [nginx LB on :80/:443]
#               → backend pool  (node-1:4000, node-2:4000, ...)
#               → frontend pool (node-1:3000, node-2:3000, ...)
#
# NOTE: For true multi-server deployment, you also need a shared database.
# SQLite is file-based and cannot be shared across machines.
# Options:
#   a) Mount a shared NFS volume containing dev.db (simple, lower performance)
#   b) Migrate to PostgreSQL (recommended for ≥2 nodes, see deploy/SCALING.md)
#   c) Use Turso (distributed SQLite — change DATABASE_URL to libsql://...)
#
# Uploads:
#   All nodes must share the same uploads directory (NFS, S3, or Cloudflare R2).
#   Set UPLOAD_DIR and BACKEND_URL accordingly on each node.

upstream sparkhub_backend {
    least_conn;                         # route to least-loaded backend
    keepalive 32;

    server node-1-ip:4000 max_fails=3 fail_timeout=30s;
    server node-2-ip:4000 max_fails=3 fail_timeout=30s;
    # server node-3-ip:4000 max_fails=3 fail_timeout=30s;  # add more nodes here
}

upstream sparkhub_frontend {
    least_conn;
    keepalive 16;

    server node-1-ip:3000 max_fails=3 fail_timeout=30s;
    server node-2-ip:3000 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;

    location / {
        proxy_pass         http://sparkhub_frontend;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection 'upgrade';
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_next_upstream error timeout http_502 http_503;  # auto-failover
    }

    location /api/ {
        rewrite            ^/api/(.*)$ /$1 break;
        proxy_pass         http://sparkhub_backend;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";           # required for keepalive
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
        proxy_next_upstream error timeout http_502 http_503;
    }

    # Health check endpoint — used by load balancer to detect dead nodes
    location /api/healthz {
        proxy_pass http://sparkhub_backend/healthz;
        access_log off;
    }
}
