generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String           @id @default(cuid())
  email            String           @unique
  emailVerified    Boolean          @default(false)
  password         String
  name             String
  role             String           @default("STUDENT")
  avatarUrl        String?
  createdAt        DateTime         @default(now())

  coursesCreated   Course[]         @relation("CreatorCourses")
  enrollments      Enrollment[]
  tutorProfile     TutorProfile?
  jobPosts         JobPosting[]
  applications     JobApplication[]
  feedbacks        Feedback[]
  messages         CourseMessage[]  @relation("UserMessages")
  eventSignups     EventSignup[]    @relation("UserEventSignups")
  eventsCreated    Event[]          @relation("EventCreator")
  resourcesAuthored Resource[]      @relation("ResourceAuthor")
  materialsUploaded CourseMaterial[] @relation("CourseMaterialUploader")
  studentSessions  Session[]        @relation("StudentSessions")
  quizAttempts     QuizAttempt[]
  certificates     Certificate[]
  tutorAvailabilities TutorAvailability[]
  auditLogs        AuditLog[]
  resetTokens     PasswordResetToken[]
  emailVerifications EmailVerificationToken[]
  emailPreference EmailPreference?
  emailLogs       EmailLog[]
  weeklyUpdates   WeeklyUpdate[]   @relation("UserWeeklyUpdates")
  assignmentsAuthored CourseAssignment[] @relation("AssignmentCreator")
  courseSubmissions  CourseSubmission[]  @relation("SubmissionStudent")
  sessions        UserSession[]
  mentorAvailabilities MentorAvailability[]
  matchRequestsFrom MatchRequest[] @relation("MatchRequestsFrom")
  matchRequestsTo   MatchRequest[] @relation("MatchRequestsTo")
  lessonProgress    LessonProgress[]
  announcements     CourseAnnouncement[] @relation("AnnouncementAuthor")
  courseRatings     CourseRating[]       @relation("CourseRatings")
  discussions       CourseDiscussion[]   @relation("DiscussionAuthor")
  discussionReplies DiscussionReply[]    @relation("ReplyAuthor")
  bookmarks         CourseBookmark[]
  noteItems         StudentNote[]
  inboxMessages     InboxMessage[]
}

model Course {
  id           String          @id @default(cuid())
  title        String
  summary      String
  coverUrl     String?
  isPublished  Boolean         @default(false)
  joinCode     String          @unique
  enrollQuestionsJson String   @default("[]")
  tagsJson     String          @default("[]")
  creator      User            @relation("CreatorCourses", fields: [creatorId], references: [id])
  creatorId    String
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  lessons      Lesson[]
  enrollments  Enrollment[]
  messages     CourseMessage[]
  quizzes      Quiz[]
  certificates Certificate[]
  sessions     CourseSession[]
  materials    CourseMaterial[]
  assignments  CourseAssignment[]
  meetingLinks CourseMeetingLink[]
  lessonProgress LessonProgress[]
  announcements  CourseAnnouncement[]
  ratings        CourseRating[]
  discussions    CourseDiscussion[]
  bookmarks      CourseBookmark[]
  notes          StudentNote[]
}

model Lesson {
  id        String     @id @default(cuid())
  course    Course     @relation(fields: [courseId], references: [id])
  courseId  String
  title     String
  type      String      // e.g. "VIDEO" | "TEXT"
  videoUrl  String?
  body      String?
  order     Int         @default(1)
  createdAt DateTime    @default(now())
  attachmentUrl String?
  contentUrl String?
  contentType String?
  durationSec Int?      // estimated lesson duration in seconds
  isPreview   Boolean   @default(false) // free preview before enrollment
  progress    LessonProgress[]
  discussions CourseDiscussion[]
  notes       StudentNote[]
}

model Enrollment {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  course    Course   @relation(fields: [courseId], references: [id])
  courseId  String
  createdAt DateTime @default(now())
  formAnswersJson String  @default("{}")
  joinedViaCode   Boolean @default(false)
  status     String   @default("PENDING")
  adminNote  String?

  @@unique([userId, courseId])
}

model CourseSession {
  id        String   @id @default(cuid())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId  String
  startsAt  DateTime
  endsAt    DateTime?
  location  String?
  mode      String? // virtual / in-person / hybrid
  note      String?
  createdAt DateTime @default(now())
}

model CourseMaterial {
  id           String   @id @default(cuid())
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId     String
  title        String
  description  String?
  coverUrl     String?
  attachmentUrl String?
  contentUrl   String?
  contentType  String?
  visibleTo    String   @default("ENROLLED")
  inlineViewer Boolean  @default(false)
  uploader     User?    @relation("CourseMaterialUploader", fields: [uploaderId], references: [id], onDelete: SetNull)
  uploaderId   String?
  createdAt    DateTime @default(now())
}

model CourseMeetingLink {
  id        String   @id @default(cuid())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId  String
  title     String
  url       String
  note      String?
  createdAt DateTime @default(now())
}

model CourseAssignment {
  id            String   @id @default(cuid())
  course        Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId      String
  title         String
  description   String?
  dueAt         DateTime?
  resourcesJson String   @default("[]")
  attachmentsJson String @default("[]")
  creator       User?    @relation("AssignmentCreator", fields: [creatorId], references: [id], onDelete: SetNull)
  creatorId     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  submissions   CourseSubmission[]
}

model CourseSubmission {
  id           String   @id @default(cuid())
  assignment   CourseAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  assignmentId String
  student      User     @relation("SubmissionStudent", fields: [studentId], references: [id])
  studentId    String
  content      String?
  attachmentUrl String?
  status       String   @default("SUBMITTED")
  grade        String?
  feedback     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([assignmentId, studentId])
}

model CourseMessage {
  id         String   @id @default(cuid())
  course     Course   @relation(fields: [courseId], references: [id])
  courseId   String
  fromUser   User     @relation("UserMessages", fields: [fromUserId], references: [id])
  fromUserId String
  content    String
  kind       String   @default("CHANNEL")
  attachmentsJson String @default("[]")
  visibility String @default("ENROLLED")
  isSystem   Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([courseId, kind])
}

model Event {
  id          String      @id @default(cuid())
  title       String
  location    String
  startsAt    DateTime
  endsAt      DateTime
  capacity    Int?
  description String?
  coverUrl    String?
  attachmentsJson String   @default("[]")
  creator     User?        @relation("EventCreator", fields: [creatorId], references: [id])
  creatorId   String?
  createdAt   DateTime    @default(now())
  signups     EventSignup[]
}

model EventSignup {
  id        String  @id @default(cuid())
  event     Event   @relation(fields: [eventId], references: [id])
  eventId   String
  user      User    @relation("UserEventSignups", fields: [userId], references: [id])
  userId    String
  note      String?
  createdAt DateTime @default(now())

  @@unique([eventId, userId])
}

model TutorProfile {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  bio         String
  subjectsCsv String   @default("")
  isPublished Boolean  @default(false)
  rateInfo    String?  // e.g. "$30/hr or Free"
  sessions    Session[]
}

model Session {
  id        String   @id @default(cuid())
  tutor     TutorProfile  @relation(fields: [tutorId], references: [id])
  tutorId   String
  student   User     @relation("StudentSessions", fields: [studentId], references: [id])
  studentId String
  startsAt  DateTime
  endsAt    DateTime
  status    String   @default("PENDING")
  note      String?
  meetingUrl String?
  createdAt DateTime @default(now())
}

model JobPosting {
  id            String   @id @default(cuid())
  recruiter     User     @relation(fields: [recruiterId], references: [id])
  recruiterId   String
  title         String
  description   String
  skillsCsv     String   @default("")
  startTime     DateTime?
  endTime       DateTime?
  duration      String?
  benefits      String?
  photosCsv     String   @default("")
  filesJson     String   @default("[]")
  contact       String
  createdAt     DateTime @default(now())
  applications  JobApplication[]
}

model JobApplication {
  id        String     @id @default(cuid())
  job       JobPosting @relation(fields: [jobId], references: [id])
  jobId     String
  user      User       @relation(fields: [userId], references: [id])
  userId    String
  message   String?
  createdAt DateTime   @default(now())

  @@unique([jobId, userId])
}

model UserSession {
  id            String   @id @default(cuid())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  userAgent     String?
  ipAddress     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastActiveAt  DateTime @default(now())
  revokedAt     DateTime?
  revokedReason String?

  @@index([userId])
}

model Feedback {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  topic     String
  content   String
  status    String   @default("OPEN")
  createdAt DateTime @default(now())
}

model Resource {
  id        String   @id @default(cuid())
  title     String
  kind      String
  url       String
  summary   String?
  details   String?
  imageUrl  String?
  attachmentUrl String?
  author    User?    @relation("ResourceAuthor", fields: [authorId], references: [id])
  authorId  String?
  createdAt DateTime @default(now())
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  code      String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@unique([userId, code])
}

model EmailPreference {
  id             String   @id @default(cuid())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String   @unique
  weeklyUpdates  Boolean  @default(true)
  productUpdates Boolean  @default(true)
  marketing      Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([active])
}

model EmailLog {
  id           String   @id @default(cuid())
  to           String
  subject      String
  bodyText     String?
  bodyHtml     String?
  status       String   @default("QUEUED")
  category     String   @default("GENERAL")
  errorMessage String?
  metadataJson String   @default("{}")
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId       String?
  createdAt    DateTime @default(now())
  sentAt       DateTime?
}

model WeeklyUpdate {
  id            String   @id @default(cuid())
  title         String
  summary       String?
  body          String
  attachmentsJson String  @default("[]")
  status        String   @default("DRAFT")
  publishAt     DateTime?
  publishedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     User?    @relation("UserWeeklyUpdates", fields: [createdById], references: [id], onDelete: SetNull)
  createdById   String?
}
model Quiz {
  id          String         @id @default(cuid())
  courseId    String
  course      Course         @relation(fields: [courseId], references: [id])
  title       String
  passScore   Int            @default(60)
  isPublished Boolean        @default(false)
  questions   QuizQuestion[]
  attempts    QuizAttempt[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

model QuizQuestion {
  id         String  @id @default(cuid())
  quizId     String
  quiz       Quiz    @relation(fields: [quizId], references: [id])
  text       String
  // store options as CSV: "A,B,C,D"
  optionsCsv String
  // index of correct option (0-based)
  correctIdx Int
  order      Int      @default(1)
}

model QuizAttempt {
  id         String   @id @default(cuid())
  quizId     String
  quiz       Quiz     @relation(fields: [quizId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  // CSV of selected indices, e.g. "0,2,1"
  answersCsv String?
  score      Int      @default(0)
  passed     Boolean  @default(false)
  createdAt  DateTime @default(now())
}

model Certificate {
  id        String   @id @default(cuid())
  code      String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id])
  issuedAt  DateTime @default(now())
  expiresAt DateTime?
}

model TutorAvailability {
  id        String   @id @default(cuid())
  tutorId   String
  tutor     User     @relation(fields: [tutorId], references: [id])
  startsAt  DateTime
  endsAt    DateTime
  createdAt DateTime @default(now())
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String
  targetType String?
  targetId   String?
  ip         String?
  userAgent  String?
  // small JSON-like payload as string for SQLite safety
  data       String?
  createdAt  DateTime @default(now())
}

model MentorAvailability {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime
  role      String   // TUTOR or STUDENT
  subjects  String?
  bio       String?
  matched   Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([date, role])
}

model MatchRequest {
  id          String   @id @default(cuid())
  fromUserId  String
  fromUser    User     @relation("MatchRequestsFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUserId    String
  toUser      User     @relation("MatchRequestsTo", fields: [toUserId], references: [id], onDelete: Cascade)
  date        DateTime
  message     String?
  status      String   @default("PENDING") // PENDING, ACCEPTED, DECLINED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([fromUserId])
  @@index([toUserId])
}

// ─── LMS v2 Models ────────────────────────────────────────────────────────────

model LessonProgress {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId    String
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  completed   Boolean  @default(false)
  completedAt DateTime?
  timeSpentSec Int     @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId, courseId])
}

model CourseAnnouncement {
  id        String   @id @default(cuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  authorId  String?
  author    User?    @relation("AnnouncementAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  title     String
  body      String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model CourseRating {
  id        String   @id @default(cuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation("CourseRatings", fields: [userId], references: [id], onDelete: Cascade)
  rating    Int      // 1–5
  review    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, userId])
  @@index([courseId])
}

model CourseDiscussion {
  id        String   @id @default(cuid())
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonId  String?
  lesson    Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  authorId  String?
  author    User?    @relation("DiscussionAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  title     String
  body      String
  isPinned  Boolean  @default(false)
  isResolved Boolean @default(false)
  replies   DiscussionReply[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@index([lessonId])
}

model DiscussionReply {
  id           String          @id @default(cuid())
  discussion   CourseDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  discussionId String
  authorId     String?
  author       User?           @relation("ReplyAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  body         String
  isInstructorReply Boolean   @default(false)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  @@index([discussionId])
}

model CourseBookmark {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId])
}

model StudentNote {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonId  String?
  lesson    Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, courseId])
}

// ─── Inbox / Messaging ────────────────────────────────────────────────────────

model InboxMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  kind      String   @default("SYSTEM") // SYSTEM | DIGEST | DM | ANNOUNCEMENT
  fromName  String?                      // sender display name
  title     String
  body      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, isRead])
  @@index([userId, createdAt])
}